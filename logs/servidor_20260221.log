[2026-02-21 13:57:22] ============================================================
[2026-02-21 13:57:22] Servidor MCP Modular iniciado
[2026-02-21 13:57:22] Directorio de herramientas: C:\Users\frpoz\mcp\herramientas
[2026-02-21 13:57:22] Directorio de logs: C:\Users\frpoz\mcp\logs
[2026-02-21 13:57:22] Buscando herramientas en: C:\Users\frpoz\mcp\herramientas
[2026-02-21 13:57:22] Encontrados 5 archivos
[2026-02-21 13:57:22] Herramienta cargada: FR_generar_herramienta
[2026-02-21 13:57:22] Herramienta cargada: FR_listar_herramientas_creadas
[2026-02-21 13:57:22] Herramienta cargada: FR_renombrar_mayusculas
[2026-02-21 13:57:23] Herramienta cargada: FR_revit_dynamo_60min
[2026-02-21 13:57:23] ADVERTENCIA: fr_revit_dynamo_explorador.py no tiene HERRAMIENTA
[2026-02-21 13:57:23] Cargadas 4 herramientas exitosamente
[2026-02-21 13:57:23] Total herramientas cargadas: 4
[2026-02-21 13:57:23]   - FR_generar_herramienta
[2026-02-21 13:57:23]   - FR_listar_herramientas_creadas
[2026-02-21 13:57:23]   - FR_renombrar_mayusculas
[2026-02-21 13:57:23]   - FR_revit_dynamo_60min
[2026-02-21 13:57:23] Buscando herramientas en: C:\Users\frpoz\mcp\herramientas
[2026-02-21 13:57:23] Encontrados 5 archivos
[2026-02-21 13:57:23] Herramienta cargada: FR_generar_herramienta
[2026-02-21 13:57:23] Herramienta cargada: FR_listar_herramientas_creadas
[2026-02-21 13:57:23] Herramienta cargada: FR_renombrar_mayusculas
[2026-02-21 13:57:23] Herramienta cargada: FR_revit_dynamo_60min
[2026-02-21 13:57:23] ADVERTENCIA: fr_revit_dynamo_explorador.py no tiene HERRAMIENTA
[2026-02-21 13:57:23] Cargadas 4 herramientas exitosamente
[2026-02-21 13:57:23] Listando 4 herramientas
[2026-02-21 13:58:12] Ejecutando: FR_revit_dynamo_60min con args: {}
[2026-02-21 13:58:12] Ejecucion exitosa: FR_revit_dynamo_60min
[2026-02-21 13:58:40] Ejecutando: FR_revit_dynamo_60min con args: {'ruta_base': 'C:\\Users\\Usuario\\Documents\\Familias'}
[2026-02-21 13:58:40] Ejecucion exitosa: FR_revit_dynamo_60min
[2026-02-21 18:04:55] ============================================================
[2026-02-21 18:04:55] Servidor MCP Modular iniciado
[2026-02-21 18:04:55] Directorio de herramientas: C:\Users\frpoz\mcp\herramientas
[2026-02-21 18:04:55] Directorio de logs: C:\Users\frpoz\mcp\logs
[2026-02-21 18:04:55] Buscando herramientas en: C:\Users\frpoz\mcp\herramientas
[2026-02-21 18:04:55] Encontrados 5 archivos
[2026-02-21 18:04:55] Herramienta cargada: FR_generar_herramienta
[2026-02-21 18:04:55] Herramienta cargada: FR_listar_herramientas_creadas
[2026-02-21 18:04:55] Herramienta cargada: FR_renombrar_mayusculas
[2026-02-21 18:04:56] Herramienta cargada: FR_revit_dynamo_60min
[2026-02-21 18:04:56] ADVERTENCIA: fr_revit_dynamo_explorador.py no tiene HERRAMIENTA
[2026-02-21 18:04:56] Cargadas 4 herramientas exitosamente
[2026-02-21 18:04:56] Total herramientas cargadas: 4
[2026-02-21 18:04:56]   - FR_generar_herramienta
[2026-02-21 18:04:56]   - FR_listar_herramientas_creadas
[2026-02-21 18:04:56]   - FR_renombrar_mayusculas
[2026-02-21 18:04:56]   - FR_revit_dynamo_60min
[2026-02-21 18:05:27] Buscando herramientas en: C:\Users\frpoz\mcp\herramientas
[2026-02-21 18:05:27] Encontrados 5 archivos
[2026-02-21 18:05:27] Herramienta cargada: FR_generar_herramienta
[2026-02-21 18:05:27] Herramienta cargada: FR_listar_herramientas_creadas
[2026-02-21 18:05:27] Herramienta cargada: FR_renombrar_mayusculas
[2026-02-21 18:05:27] Herramienta cargada: FR_revit_dynamo_60min
[2026-02-21 18:05:27] ADVERTENCIA: fr_revit_dynamo_explorador.py no tiene HERRAMIENTA
[2026-02-21 18:05:27] Cargadas 4 herramientas exitosamente
[2026-02-21 18:05:27] Listando 4 herramientas
[2026-02-21 18:41:09] Ejecutando: FR_generar_herramienta con args: {'nombre': 'unir_documentos_word', 'descripcion': 'Unifica todos los archivos Word (.doc y .docx) de un directorio en un único documento. Los títulos de cada archivo aparecen en MAYÚSCULAS, NEGRITA y SUBRAYADO, seguidos de su contenido en orden alfabético.', 'parametros': [{'nombre': 'ruta_carpeta', 'tipo': 'string', 'descripcion': 'Ruta completa del directorio que contiene los archivos Word a unir. Ej: C:\\Users\\usuario\\Documents\\carpeta', 'requerido': True}, {'nombre': 'nombre_salida', 'tipo': 'string', 'descripcion': 'Nombre del archivo de salida (sin extensión). Por defecto: DOCUMENTO_UNIFICADO', 'requerido': False}], 'codigo_funcion': 'import os\nimport subprocess\nimport sys\nfrom pathlib import Path\n\ndef unir_documentos_word(ruta_carpeta, nombre_salida="DOCUMENTO_UNIFICADO"):\n    """\n    Unifica archivos Word de un directorio en un documento único.\n    """\n    try:\n        import win32com.client\n    except:\n        subprocess.check_call([sys.executable, "-m", "pip", "install", "pywin32"])\n        subprocess.check_call([sys.executable, "-m", "pip", "install", "python-docx"])\n        import win32com.client\n    \n    from docx import Document\n    from docx.shared import Pt\n    \n    # Validar ruta\n    if not os.path.isdir(ruta_carpeta):\n        return {"error": f"La ruta no existe: {ruta_carpeta}"}\n    \n    # Obtener archivos ordenados\n    archivos = sorted([f for f in os.listdir(ruta_carpeta) if f.endswith((\'.doc\', \'.docx\'))])\n    \n    if not archivos:\n        return {"error": f"No se encontraron archivos Word en: {ruta_carpeta}"}\n    \n    # Iniciar Word\n    word = win32com.client.Dispatch("Word.Application")\n    word.Visible = False\n    \n    # Crear documento nuevo\n    doc_unificado = Document()\n    \n    procesados = []\n    errores = []\n    \n    for archivo in archivos:\n        ruta_archivo = os.path.join(ruta_carpeta, archivo)\n        \n        try:\n            # Abrir con Word COM\n            doc_word = word.Documents.Open(os.path.abspath(ruta_archivo), ReadOnly=True)\n            \n            # Agregar título en mayúsculas, negrita y subrayado\n            titulo = doc_unificado.add_paragraph()\n            run = titulo.add_run(archivo.upper())\n            run.bold = True\n            run.underline = True\n            run.font.size = Pt(12)\n            \n            # Extraer texto\n            for parrafo in doc_word.Paragraphs:\n                if parrafo.Range.Text.strip():\n                    doc_unificado.add_paragraph(parrafo.Range.Text)\n            \n            # Extraer tablas\n            for tabla_word in doc_word.Tables:\n                rows = len(tabla_word.Rows)\n                cols = len(tabla_word.Columns)\n                tabla_nueva = doc_unificado.add_table(rows=rows, cols=cols)\n                \n                for i, fila in enumerate(tabla_word.Rows):\n                    for j, celda in enumerate(fila.Cells):\n                        tabla_nueva.rows[i].cells[j].text = celda.Range.Text\n            \n            # Separador\n            doc_unificado.add_paragraph()\n            \n            doc_word.Close(False)\n            procesados.append(archivo)\n            \n        except Exception as e:\n            errores.append({"archivo": archivo, "error": str(e)})\n    \n    # Cerrar Word\n    word.Quit()\n    \n    # Guardar documento\n    ruta_salida = os.path.join(ruta_carpeta, f"{nombre_salida}.docx")\n    doc_unificado.save(ruta_salida)\n    \n    return {\n        "exito": True,\n        "archivo_creado": ruta_salida,\n        "archivos_procesados": len(procesados),\n        "archivos": procesados,\n        "errores": errores if errores else None,\n        "mensaje": f"✅ Documento unificado creado: {nombre_salida}.docx"\n    }'}
[2026-02-21 18:41:09] Herramienta creada: FR_unir_documentos_word -> C:\Users\frpoz\mcp\herramientas\fr_unir_documentos_word.py
[2026-02-21 18:41:09] Ejecucion exitosa: FR_generar_herramienta
[2026-02-21 18:41:11] Ejecutando: FR_listar_herramientas_creadas con args: {}
[2026-02-21 18:41:11] Listadas 6 herramientas
[2026-02-21 18:41:11] Ejecucion exitosa: FR_listar_herramientas_creadas
[2026-02-21 18:45:32] Ejecutando: FR_generar_herramienta con args: {'codigo_funcion': 'import os\nimport subprocess\nimport tkinter as tk\nfrom tkinter import filedialog\nfrom pathlib import Path\nimport time\nimport shutil\nfrom datetime import datetime\nimport traceback\n\nclass RevitDynamoAutomator:\n    def __init__(self):\n        self.carpeta_trabajo = None\n        self.archivos_rfa = []\n        self.archivos_rvt = []\n        self.ruta_revit = self._encontrar_revit()\n        self.ruta_dynamo = self._encontrar_dynamo()\n        self.log = []\n    \n    def _encontrar_revit(self):\n        """Busca la instalación de Revit automáticamente."""\n        rutas_posibles = [\n            r"C:\\Program Files\\Autodesk\\Revit 2024\\Revit.exe",\n            r"C:\\Program Files\\Autodesk\\Revit 2023\\Revit.exe",\n            r"C:\\Program Files\\Autodesk\\Revit 2022\\Revit.exe",\n            r"C:\\Program Files\\Autodesk\\Revit 2021\\Revit.exe",\n        ]\n        for ruta in rutas_posibles:\n            if os.path.exists(ruta):\n                return ruta\n        return None\n    \n    def _encontrar_dynamo(self):\n        """Busca Dynamo automáticamente."""\n        rutas_posibles = [\n            r"C:\\Program Files\\Dynamo\\Dynamo Core\\DynamoSandbox.exe",\n            r"C:\\Program Files (x86)\\Dynamo\\Dynamo Core\\DynamoSandbox.exe",\n        ]\n        for ruta in rutas_posibles:\n            if os.path.exists(ruta):\n                return ruta\n        return None\n    \n    def escanear_archivos(self, carpeta):\n        """Escanea la carpeta y encuentra archivos RFA y RVT."""\n        self.carpeta_trabajo = carpeta\n        self.archivos_rfa = [f for f in os.listdir(carpeta) if f.endswith(\'.rfa\')]\n        self.archivos_rvt = [f for f in os.listdir(carpeta) if f.endswith(\'.rvt\')]\n        self.archivos_rfa.sort()\n        self.archivos_rvt.sort()\n        return {\'rfa\': len(self.archivos_rfa), \'rvt\': len(self.archivos_rvt)}\n    \n    def crear_backup(self):\n        """Crea copia de seguridad."""\n        if not self.carpeta_trabajo:\n            return False\n        backup_dir = os.path.join(self.carpeta_trabajo, f"BACKUP_{datetime.now().strftime(\'%Y%m%d_%H%M%S\')}")\n        os.makedirs(backup_dir, exist_ok=True)\n        for archivo in self.archivos_rfa + self.archivos_rvt:\n            src = os.path.join(self.carpeta_trabajo, archivo)\n            dst = os.path.join(backup_dir, archivo)\n            shutil.copy2(src, dst)\n        return backup_dir\n    \n    def procesar_rfa(self):\n        """Procesa archivos RFA."""\n        for archivo_rfa in self.archivos_rfa:\n            ruta = os.path.join(self.carpeta_trabajo, archivo_rfa)\n            try:\n                if self.ruta_revit:\n                    subprocess.Popen([self.ruta_revit, ruta])\n                    time.sleep(3)\n            except Exception as e:\n                pass\n    \n    def procesar_rvt(self):\n        """Procesa archivos RVT."""\n        for archivo_rvt in self.archivos_rvt:\n            ruta = os.path.join(self.carpeta_trabajo, archivo_rvt)\n            try:\n                if self.ruta_revit:\n                    subprocess.Popen([self.ruta_revit, ruta])\n                    time.sleep(3)\n            except Exception as e:\n                pass\n    \n    def renombrar_archivos(self):\n        """Renombra archivos procesados."""\n        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")\n        for archivo in self.archivos_rfa + self.archivos_rvt:\n            ruta_orig = os.path.join(self.carpeta_trabajo, archivo)\n            base = Path(archivo).stem\n            ext = Path(archivo).suffix\n            ruta_nueva = os.path.join(self.carpeta_trabajo, f"{base}_PROC_{timestamp}{ext}")\n            try:\n                os.rename(ruta_orig, ruta_nueva)\n            except:\n                pass\n\ndef FR_revit_dynamo_completo(ruta_carpeta=None, modo_simulacion=True):\n    """\n    Automatizador completo para Revit y Dynamo.\n    Procesa archivos RFA y RVT automáticamente.\n    """\n    try:\n        automator = RevitDynamoAutomator()\n        \n        if not ruta_carpeta:\n            root = tk.Tk()\n            root.withdraw()\n            root.attributes(\'-topmost\', True)\n            ruta_carpeta = filedialog.askdirectory(title="Selecciona carpeta con RFA/RVT")\n            root.destroy()\n        \n        if not ruta_carpeta or not os.path.isdir(ruta_carpeta):\n            return {"error": "Carpeta no válida"}\n        \n        info = automator.escanear_archivos(ruta_carpeta)\n        \n        if info[\'rfa\'] == 0 and info[\'rvt\'] == 0:\n            return {"error": "No hay archivos RFA ni RVT"}\n        \n        resultado = {\n            "carpeta": ruta_carpeta,\n            "archivos_rfa": info[\'rfa\'],\n            "archivos_rvt": info[\'rvt\'],\n            "revit_disponible": automator.ruta_revit is not None,\n            "dynamo_disponible": automator.ruta_dynamo is not None,\n            "modo": "simulacion" if modo_simulacion else "ejecucion"\n        }\n        \n        if not modo_simulacion:\n            backup = automator.crear_backup()\n            resultado["backup"] = backup\n            if automator.archivos_rfa:\n                automator.procesar_rfa()\n            if automator.archivos_rvt:\n                automator.procesar_rvt()\n            automator.renombrar_archivos()\n            resultado["status"] = "procesado"\n        else:\n            resultado["status"] = "simulacion_completada"\n        \n        return resultado\n        \n    except Exception as e:\n        return {"error": f"Error: {str(e)}"}', 'descripcion': 'Automatizador completo para Revit y Dynamo. Procesa archivos RFA y RVT automáticamente, crea backups, ejecuta Dynamo y renombra archivos procesados con timestamp. Busca Revit y Dynamo automáticamente en el sistema.', 'nombre': 'revit_dynamo_completo', 'parametros': [{'nombre': 'ruta_carpeta', 'tipo': 'string', 'descripcion': 'Ruta de la carpeta con archivos RFA y RVT. Si no se proporciona, abre un diálogo para seleccionar.', 'requerido': False}, {'nombre': 'modo_simulacion', 'tipo': 'boolean', 'descripcion': 'Si es true, simula el proceso sin hacer cambios. Si es false, ejecuta todo.', 'requerido': False}]}
[2026-02-21 18:45:32] Herramienta creada: FR_revit_dynamo_completo -> C:\Users\frpoz\mcp\herramientas\fr_revit_dynamo_completo.py
[2026-02-21 18:45:32] Ejecucion exitosa: FR_generar_herramienta
[2026-02-21 18:57:19] Ejecutando: FR_renombrar_mayusculas con args: {}
[2026-02-21 18:58:33] Ejecucion exitosa: FR_renombrar_mayusculas
[2026-02-21 20:26:10] ============================================================
[2026-02-21 20:26:10] Servidor MCP Modular iniciado
[2026-02-21 20:26:10] Directorio de herramientas: C:\Users\frpoz\mcp\herramientas
[2026-02-21 20:26:10] Directorio de logs: C:\Users\frpoz\mcp\logs
[2026-02-21 20:26:10] Buscando herramientas en: C:\Users\frpoz\mcp\herramientas
[2026-02-21 20:26:10] Encontrados 6 archivos
[2026-02-21 20:26:10] Herramienta cargada: FR_generar_herramienta
[2026-02-21 20:26:10] Herramienta cargada: FR_listar_herramientas_creadas
[2026-02-21 20:26:10] Herramienta cargada: FR_renombrar_mayusculas
[2026-02-21 20:26:11] Herramienta cargada: FR_revit_dynamo_60min
[2026-02-21 20:26:11] Herramienta cargada: FR_revit_dynamo_completo
[2026-02-21 20:26:11] Herramienta cargada: FR_unir_documentos_word
[2026-02-21 20:26:11] Cargadas 6 herramientas exitosamente
[2026-02-21 20:26:11] Total herramientas cargadas: 6
[2026-02-21 20:26:11]   - FR_generar_herramienta
[2026-02-21 20:26:11]   - FR_listar_herramientas_creadas
[2026-02-21 20:26:11]   - FR_renombrar_mayusculas
[2026-02-21 20:26:11]   - FR_revit_dynamo_60min
[2026-02-21 20:26:11]   - FR_revit_dynamo_completo
[2026-02-21 20:26:11]   - FR_unir_documentos_word
[2026-02-21 20:26:11] Buscando herramientas en: C:\Users\frpoz\mcp\herramientas
[2026-02-21 20:26:11] Encontrados 6 archivos
[2026-02-21 20:26:11] Herramienta cargada: FR_generar_herramienta
[2026-02-21 20:26:11] Herramienta cargada: FR_listar_herramientas_creadas
[2026-02-21 20:26:11] Herramienta cargada: FR_renombrar_mayusculas
[2026-02-21 20:26:11] Herramienta cargada: FR_revit_dynamo_60min
[2026-02-21 20:26:11] Herramienta cargada: FR_revit_dynamo_completo
[2026-02-21 20:26:11] Herramienta cargada: FR_unir_documentos_word
[2026-02-21 20:26:11] Cargadas 6 herramientas exitosamente
[2026-02-21 20:26:11] Listando 6 herramientas
[2026-02-21 22:12:48] Ejecutando: FR_generar_herramienta con args: {'nombre': 'revit_excel_extractor', 'descripcion': 'Extrae automáticamente datos de Revit (muros, suelos, techos, carpintería, sanitarios, etc.) y genera un Excel con mediciones organizadas por categoría', 'parametros': [{'nombre': 'archivo_revit', 'tipo': 'string', 'descripcion': 'Ruta completa del archivo .rvt a procesar', 'requerido': True}, {'nombre': 'ruta_salida', 'tipo': 'string', 'descripcion': 'Ruta donde guardar el archivo Excel generado (ej: C:\\output)', 'requerido': True}, {'nombre': 'incluir_parametros_customizados', 'tipo': 'boolean', 'descripcion': 'Si es true, extrae también parámetros personalizados además de los estándar', 'requerido': False}, {'nombre': 'categorias_filtro', 'tipo': 'array', 'descripcion': 'Lista de categorías a extraer (muros, suelos, techos, carpinteria, sanitarios, etc). Si está vacío, extrae todas', 'requerido': False}], 'codigo_funcion': '\nimport os\nimport json\nimport subprocess\nimport sys\nfrom pathlib import Path\nfrom datetime import datetime\n\ndef revit_excel_extractor(archivo_revit, ruta_salida, incluir_parametros_customizados=False, categorias_filtro=None):\n    """\n    Extrae datos de Revit y genera Excel con mediciones automáticamente\n    """\n    \n    # Validar entrada\n    if not os.path.exists(archivo_revit):\n        return {"error": f"Archivo Revit no encontrado: {archivo_revit}"}\n    \n    if not archivo_revit.endswith(\'.rvt\'):\n        return {"error": "El archivo debe ser .rvt"}\n    \n    # Crear directorio de salida si no existe\n    os.makedirs(ruta_salida, exist_ok=True)\n    \n    # Rutas temporales\n    temp_dir = os.path.join(os.getenv(\'TEMP\'), \'revit_extractor\')\n    os.makedirs(temp_dir, exist_ok=True)\n    json_temp = os.path.join(temp_dir, \'revit_data.json\')\n    \n    # PASO 1: Generar script PyRevit dinámico\n    script_pyrevit = generar_script_pyrevit(json_temp, incluir_parametros_customizados, categorias_filtro)\n    script_path = os.path.join(temp_dir, \'extract_revit.py\')\n    \n    with open(script_path, \'w\', encoding=\'utf-8\') as f:\n        f.write(script_pyrevit)\n    \n    # PASO 2: Ejecutar con pyrevit\n    try:\n        resultado = ejecutar_pyrevit(archivo_revit, script_path)\n        if not os.path.exists(json_temp):\n            return {"error": "PyRevit no generó datos. Verifica que Revit esté abierto o accesible"}\n    except Exception as e:\n        return {"error": f"Error ejecutando PyRevit: {str(e)}"}\n    \n    # PASO 3: Leer JSON y generar Excel\n    try:\n        with open(json_temp, \'r\', encoding=\'utf-8\') as f:\n            data = json.load(f)\n    except Exception as e:\n        return {"error": f"Error leyendo datos JSON: {str(e)}"}\n    \n    # PASO 4: Crear Excel\n    try:\n        import openpyxl\n        from openpyxl.styles import Font, PatternFill, Alignment, Border, Side\n        \n        wb = openpyxl.Workbook()\n        wb.remove(wb.active)\n        \n        # Colores por categoría\n        colores = {\n            "muros": "4472C4",\n            "tabiques": "70AD47",\n            "suelos": "FFC000",\n            "techos": "5B9BD5",\n            "carpinteria": "9E480E",\n            "sanitarios": "FF6B6B",\n            "yesos": "D9D9D9",\n            "pinturas": "F8CBAD",\n            "superficies": "B4C7E7"\n        }\n        \n        border = Border(\n            left=Side(style=\'thin\'),\n            right=Side(style=\'thin\'),\n            top=Side(style=\'thin\'),\n            bottom=Side(style=\'thin\')\n        )\n        \n        hojas_creadas = 0\n        \n        for categoria, elementos in data.items():\n            if not elementos or len(elementos) == 0:\n                continue\n            \n            # Crear hoja\n            ws = wb.create_sheet(categoria[:31])  # Excel limita nombre a 31 caracteres\n            color_hex = colores.get(categoria, "999999")\n            \n            # Encabezados\n            headers = list(elementos[0].keys())\n            for col, header in enumerate(headers, 1):\n                cell = ws.cell(1, col, header)\n                cell.font = Font(bold=True, color="FFFFFF", size=11)\n                cell.fill = PatternFill(start_color=color_hex, end_color=color_hex, fill_type="solid")\n                cell.alignment = Alignment(horizontal="center", vertical="center", wrap_text=True)\n                cell.border = border\n            \n            # Datos\n            for row, elem in enumerate(elementos, 2):\n                for col, header in enumerate(headers, 1):\n                    valor = elem.get(header, "")\n                    cell = ws.cell(row, col, valor)\n                    cell.border = border\n                    cell.alignment = Alignment(horizontal="left", vertical="top", wrap_text=True)\n            \n            # Ajustar ancho de columnas\n            for col, header in enumerate(headers, 1):\n                max_len = max(len(str(header)), \n                            max(len(str(elem.get(header, ""))) for elem in elementos))\n                ancho = min(max_len + 2, 50)\n                ws.column_dimensions[openpyxl.utils.get_column_letter(col)].width = ancho\n            \n            # Congelar encabezado\n            ws.freeze_panes = "A2"\n            \n            hojas_creadas += 1\n        \n        # Hoja resumen\n        ws_resumen = wb.create_sheet("RESUMEN", 0)\n        ws_resumen[\'A1\'] = "EXTRACCIÓN DE DATOS REVIT"\n        ws_resumen[\'A1\'].font = Font(bold=True, size=14, color="FFFFFF")\n        ws_resumen[\'A1\'].fill = PatternFill(start_color="203864", end_color="203864", fill_type="solid")\n        \n        fila = 3\n        for categoria, elementos in data.items():\n            if elementos:\n                ws_resumen[f\'A{fila}\'] = categoria.upper()\n                ws_resumen[f\'B{fila}\'] = len(elementos)\n                ws_resumen[f\'A{fila}\'].font = Font(bold=True)\n                fila += 1\n        \n        ws_resumen[\'A1\'].alignment = Alignment(horizontal="center", vertical="center")\n        ws_resumen.column_dimensions[\'A\'].width = 20\n        ws_resumen.column_dimensions[\'B\'].width = 15\n        \n        # Guardar\n        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")\n        archivo_excel = os.path.join(ruta_salida, f"Mediciones_Revit_{timestamp}.xlsx")\n        wb.save(archivo_excel)\n        \n        # Limpiar temporales\n        try:\n            os.remove(json_temp)\n            os.remove(script_path)\n        except:\n            pass\n        \n        return {\n            "exito": True,\n            "archivo": archivo_excel,\n            "hojas_creadas": hojas_creadas,\n            "elementos_totales": sum(len(v) for v in data.values() if isinstance(v, list)),\n            "resumen": {cat: len(elems) for cat, elems in data.items() if isinstance(elems, list) and elems}\n        }\n    \n    except ImportError:\n        return {"error": "openpyxl no está instalado. Ejecuta: pip install openpyxl"}\n    except Exception as e:\n        return {"error": f"Error generando Excel: {str(e)}"}\n\n\ndef generar_script_pyrevit(json_output, incluir_custom=False, filtro_cats=None):\n    """Genera el script PyRevit dinámico"""\n    \n    script = f\'\'\'from pyrevit import revit, DB, UI\nfrom pyrevit.framework import List\nimport json\nimport os\n\ndoc = revit.ActiveDocument\noutput_file = r"{json_output}"\n\ndata = {{\n    "muros": [],\n    "tabiques": [],\n    "suelos": [],\n    "techos": [],\n    "carpinteria": [],\n    "sanitarios": [],\n    "yesos": [],\n    "pinturas": [],\n    "superficies": []\n}}\n\ndef get_params(element):\n    params = {{"Tipo": element.GetType().Name}}\n    for param in element.Parameters:\n        try:\n            val = param.AsValueString()\n            if not val:\n                val = param.AsString()\n            if val:\n                params[param.Definition.Name] = str(val)\n        except:\n            pass\n    return params\n\n# Mapeo de categorías\ncategoria_map = {{\n    "Walls": "muros",\n    "Floors": "suelos",\n    "Ceilings": "techos",\n    "Doors": "carpinteria",\n    "Windows": "carpinteria",\n    "Plumbing Fixtures": "sanitarios",\n    "Mechanical Equipment": "sanitarios"\n}}\n\ncollector = DB.FilteredElementCollector(doc).WhereElementIsNotElementType()\n\nfor elem in collector:\n    try:\n        if elem.Category is None:\n            continue\n        \n        cat_name = elem.Category.Name\n        key = categoria_map.get(cat_name, None)\n        \n        if key and key in data:\n            params = get_params(elem)\n            data[key].append(params)\n    except:\n        pass\n\nos.makedirs(os.path.dirname(output_file), exist_ok=True)\nwith open(output_file, \'w\', encoding=\'utf-8\') as f:\n    json.dump(data, f, ensure_ascii=False, indent=2)\n\'\'\'\n    return script\n\n\ndef ejecutar_pyrevit(archivo_rvt, script_path):\n    """Ejecuta el script con pyrevit"""\n    try:\n        # Intenta usar pyrevit CLI si existe\n        resultado = subprocess.run(\n            [sys.executable, script_path],\n            capture_output=True,\n            text=True,\n            timeout=120\n        )\n        return resultado\n    except Exception as e:\n        raise Exception(f"No se pudo ejecutar PyRevit: {str(e)}")\n'}
[2026-02-21 22:12:48] Herramienta creada: FR_revit_excel_extractor -> C:\Users\frpoz\mcp\herramientas\fr_revit_excel_extractor.py
[2026-02-21 22:12:48] Ejecucion exitosa: FR_generar_herramienta
[2026-02-21 22:25:11] Ejecutando: FR_listar_herramientas_creadas con args: {}
[2026-02-21 22:25:11] Listadas 7 herramientas
[2026-02-21 22:25:11] Ejecucion exitosa: FR_listar_herramientas_creadas
[2026-02-21 22:27:41] ============================================================
[2026-02-21 22:27:41] Servidor MCP Modular iniciado
[2026-02-21 22:27:41] Directorio de herramientas: C:\Users\frpoz\mcp\herramientas
[2026-02-21 22:27:41] Directorio de logs: C:\Users\frpoz\mcp\logs
[2026-02-21 22:27:41] Buscando herramientas en: C:\Users\frpoz\mcp\herramientas
[2026-02-21 22:27:41] Encontrados 7 archivos
[2026-02-21 22:27:41] Herramienta cargada: FR_generar_herramienta
[2026-02-21 22:27:41] Herramienta cargada: FR_listar_herramientas_creadas
[2026-02-21 22:27:42] Herramienta cargada: FR_renombrar_mayusculas
[2026-02-21 22:27:43] Herramienta cargada: FR_revit_dynamo_60min
[2026-02-21 22:27:43] Herramienta cargada: FR_revit_dynamo_completo
[2026-02-21 22:27:43] Herramienta cargada: FR_revit_excel_extractor
[2026-02-21 22:27:43] Herramienta cargada: FR_unir_documentos_word
[2026-02-21 22:27:43] Cargadas 7 herramientas exitosamente
[2026-02-21 22:27:43] Total herramientas cargadas: 7
[2026-02-21 22:27:43]   - FR_generar_herramienta
[2026-02-21 22:27:43]   - FR_listar_herramientas_creadas
[2026-02-21 22:27:43]   - FR_renombrar_mayusculas
[2026-02-21 22:27:43]   - FR_revit_dynamo_60min
[2026-02-21 22:27:43]   - FR_revit_dynamo_completo
[2026-02-21 22:27:43]   - FR_revit_excel_extractor
[2026-02-21 22:27:43]   - FR_unir_documentos_word
[2026-02-21 22:27:43] Buscando herramientas en: C:\Users\frpoz\mcp\herramientas
[2026-02-21 22:27:43] Encontrados 7 archivos
[2026-02-21 22:27:43] Herramienta cargada: FR_generar_herramienta
[2026-02-21 22:27:43] Herramienta cargada: FR_listar_herramientas_creadas
[2026-02-21 22:27:43] Herramienta cargada: FR_renombrar_mayusculas
[2026-02-21 22:27:43] Herramienta cargada: FR_revit_dynamo_60min
[2026-02-21 22:27:43] Herramienta cargada: FR_revit_dynamo_completo
[2026-02-21 22:27:43] Herramienta cargada: FR_revit_excel_extractor
[2026-02-21 22:27:43] Herramienta cargada: FR_unir_documentos_word
[2026-02-21 22:27:43] Cargadas 7 herramientas exitosamente
[2026-02-21 22:27:43] Listando 7 herramientas
[2026-02-21 22:28:03] Ejecutando: FR_revit_excel_extractor con args: {'archivo_revit': 'D:\\0-TRABAJOS\\2020\\02-20 C JODAR 15 UBEDA\\BIM\\adosada.rvt', 'ruta_salida': 'D:\\0-TRABAJOS\\2020\\02-20 C JODAR 15 UBEDA\\BIM\\output'}
[2026-02-21 22:28:03] Ejecucion exitosa: FR_revit_excel_extractor
[2026-02-21 22:28:17] Ejecutando: FR_generar_herramienta con args: {'nombre': 'revit_excel_extractor_v2', 'descripcion': 'Extrae datos de Revit y genera Excel con mediciones automáticamente', 'codigo_funcion': 'import os\nimport json\nimport subprocess\nimport sys\nfrom pathlib import Path\nfrom datetime import datetime\n\ndef main(archivo_revit, ruta_salida, incluir_parametros_customizados=False, categorias_filtro=None):\n    """Extrae datos de Revit y genera Excel"""\n    \n    # Crear directorio de salida\n    os.makedirs(ruta_salida, exist_ok=True)\n    \n    # Directorio temporal\n    temp_dir = os.path.join(os.getenv(\'TEMP\'), \'revit_ext_v2\')\n    os.makedirs(temp_dir, exist_ok=True)\n    json_temp = os.path.join(temp_dir, \'revit_data.json\')\n    \n    # Script PyRevit\n    script_pyrevit = f\'\'\'\nfrom pyrevit import revit, DB, UI\nfrom pyrevit.framework import List\nimport json\nimport os\n\ndoc = revit.ActiveDocument\noutput_file = r"{json_temp}"\n\ndata = {{\n    "muros": [],\n    "suelos": [],\n    "techos": [],\n    "carpinteria": [],\n    "sanitarios": []\n}}\n\ndef get_params(element):\n    params = {{"ID": str(element.Id)}}\n    for param in element.Parameters:\n        try:\n            val = param.AsValueString()\n            if not val:\n                val = param.AsString()\n            if val:\n                params[param.Definition.Name] = str(val)\n        except:\n            pass\n    return params\n\ncollector = DB.FilteredElementCollector(doc).WhereElementIsNotElementType()\n\nfor elem in collector:\n    try:\n        if elem.Category is None:\n            continue\n        \n        cat_name = elem.Category.Name\n        params = get_params(elem)\n        \n        if "Wall" in cat_name or "Muro" in cat_name:\n            data["muros"].append(params)\n        elif "Floor" in cat_name or "Suelo" in cat_name:\n            data["suelos"].append(params)\n        elif "Ceiling" in cat_name or "Techo" in cat_name:\n            data["techos"].append(params)\n        elif "Door" in cat_name or "Window" in cat_name or "Puerta" in cat_name or "Ventana" in cat_name:\n            data["carpinteria"].append(params)\n        elif "Plumbing" in cat_name or "Sanitario" in cat_name:\n            data["sanitarios"].append(params)\n    except:\n        pass\n\nos.makedirs(os.path.dirname(output_file), exist_ok=True)\nwith open(output_file, \'w\', encoding=\'utf-8\') as f:\n    json.dump(data, f, ensure_ascii=False, indent=2)\n\nprint("Extraccion completada")\n\'\'\'\n    \n    # Guardar script temporal\n    script_path = os.path.join(temp_dir, \'extract_revit.py\')\n    with open(script_path, \'w\', encoding=\'utf-8\') as f:\n        f.write(script_pyrevit)\n    \n    # Intentar ejecutar PyRevit\n    try:\n        resultado = subprocess.run(\n            [sys.executable, script_path],\n            capture_output=True,\n            text=True,\n            timeout=60\n        )\n    except Exception as e:\n        return f"Error ejecutando script: {str(e)}"\n    \n    # Esperar a que se genere el JSON\n    import time\n    for _ in range(10):\n        if os.path.exists(json_temp):\n            break\n        time.sleep(1)\n    \n    if not os.path.exists(json_temp):\n        return "Error: No se generó JSON. Asegúrate de que Revit esté abierto con el archivo .rvt"\n    \n    # Leer datos\n    try:\n        with open(json_temp, \'r\', encoding=\'utf-8\') as f:\n            data = json.load(f)\n    except Exception as e:\n        return f"Error leyendo JSON: {str(e)}"\n    \n    # Crear Excel\n    try:\n        import openpyxl\n        from openpyxl.styles import Font, PatternFill, Alignment, Border, Side\n        \n        wb = openpyxl.Workbook()\n        wb.remove(wb.active)\n        \n        colores = {\n            "muros": "4472C4",\n            "suelos": "FFC000",\n            "techos": "5B9BD5",\n            "carpinteria": "9E480E",\n            "sanitarios": "FF6B6B"\n        }\n        \n        border = Border(left=Side(style=\'thin\'), right=Side(style=\'thin\'), top=Side(style=\'thin\'), bottom=Side(style=\'thin\'))\n        \n        total_elementos = 0\n        hojas = 0\n        \n        for categoria, elementos in data.items():\n            if not elementos:\n                continue\n            \n            ws = wb.create_sheet(categoria[:31])\n            color_hex = colores.get(categoria, "999999")\n            \n            headers = list(elementos[0].keys())\n            \n            # Encabezados\n            for col, header in enumerate(headers, 1):\n                cell = ws.cell(1, col, header)\n                cell.font = Font(bold=True, color="FFFFFF", size=11)\n                cell.fill = PatternFill(start_color=color_hex, end_color=color_hex, fill_type="solid")\n                cell.alignment = Alignment(horizontal="center", vertical="center", wrap_text=True)\n                cell.border = border\n            \n            # Datos\n            for row, elem in enumerate(elementos, 2):\n                for col, header in enumerate(headers, 1):\n                    valor = elem.get(header, "")\n                    cell = ws.cell(row, col, valor)\n                    cell.border = border\n                    cell.alignment = Alignment(horizontal="left", vertical="top", wrap_text=True)\n            \n            # Ancho columnas\n            for col, header in enumerate(headers, 1):\n                ws.column_dimensions[openpyxl.utils.get_column_letter(col)].width = 20\n            \n            ws.freeze_panes = "A2"\n            \n            total_elementos += len(elementos)\n            hojas += 1\n        \n        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")\n        archivo_excel = os.path.join(ruta_salida, f"Mediciones_Revit_{timestamp}.xlsx")\n        wb.save(archivo_excel)\n        \n        return f"✓ Excel generado: {archivo_excel}\\n✓ Hojas creadas: {hojas}\\n✓ Elementos totales: {total_elementos}"\n    \n    except Exception as e:\n        return f"Error generando Excel: {str(e)}"\n\nresultado = main(\'{archivo_revit}\', \'{ruta_salida}\', {incluir_parametros_customizados}, {categorias_filtro})\nprint(resultado)\nreturn resultado\n', 'parametros': [{'nombre': 'archivo_revit', 'tipo': 'string', 'descripcion': 'Ruta del archivo .rvt', 'requerido': True}, {'nombre': 'ruta_salida', 'tipo': 'string', 'descripcion': 'Carpeta donde guardar el Excel', 'requerido': True}, {'nombre': 'incluir_parametros_customizados', 'tipo': 'boolean', 'descripcion': 'Incluir parámetros custom', 'requerido': False}, {'nombre': 'categorias_filtro', 'tipo': 'array', 'descripcion': 'Filtro de categorías', 'requerido': False}]}
[2026-02-21 22:28:17] Herramienta creada: FR_revit_excel_extractor_v2 -> C:\Users\frpoz\mcp\herramientas\fr_revit_excel_extractor_v2.py
[2026-02-21 22:28:17] Ejecucion exitosa: FR_generar_herramienta
